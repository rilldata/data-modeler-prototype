<script lang="ts">
  import { fileArtifacts } from "@rilldata/web-common/features/entity-management/file-artifacts";
  import { WatchFilesClient } from "@rilldata/web-common/features/entity-management/WatchFilesClient";
  import { WatchResourcesClient } from "@rilldata/web-common/features/entity-management/WatchResourcesClient";
  import { errorEventHandler } from "@rilldata/web-common/metrics/initMetrics";
  import { queryClient } from "@rilldata/web-common/lib/svelte-query/globalQueryClient";
  import { onMount } from "svelte";

  const fileWatcher = new WatchFilesClient().client;
  const resourceWatcher = new WatchResourcesClient().client;

  export let host: string;
  export let instanceId: string;

  $: fileWatcher.watch(`${host}/v1/instances/${instanceId}/files/watch`);

  $: resourceWatcher.watch(
    `${host}/v1/instances/${instanceId}/resources/-/watch`,
  );

  onMount(() => {
    const stopJavascriptErrorListeners =
      errorEventHandler?.addJavascriptErrorListeners();
    void fileArtifacts.init(queryClient, instanceId);

    return () => {
      fileWatcher.cancel();
      resourceWatcher.cancel();
      stopJavascriptErrorListeners?.();
    };
  });

  function handleVisibilityChange() {
    if (document.visibilityState === "visible") {
      fileWatcher.reconnect().catch(console.error);
      resourceWatcher.reconnect().catch(console.error);
    } else {
      fileWatcher.throttle();
      resourceWatcher.throttle();
    }
  }
</script>

<svelte:window on:visibilitychange={handleVisibilityChange} />

<slot />

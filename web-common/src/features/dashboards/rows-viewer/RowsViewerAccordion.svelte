<script lang="ts">
  import CaretUpIcon from "@rilldata/web-common/components/icons/CaretUpIcon.svelte";
  import RowsViewer from "./RowsViewer.svelte";
  import CaretDownIcon from "@rilldata/web-common/components/icons/CaretDownIcon.svelte";
  import { createQueryServiceMetricsViewTotals } from "@rilldata/web-common/runtime-client";
  import { runtime } from "@rilldata/web-common/runtime-client/runtime-store";
  import { formatCompactInteger } from "@rilldata/web-common/lib/formatters";
  import { useDashboardStore } from "../dashboard-stores";
  import { useModelHasTimeSeries } from "../selectors";
  export let metricViewName: string;
  let isOpen = false;
  const toggle = () => {
    isOpen = !isOpen;
  };

  $: totalsQuery = createQueryServiceMetricsViewTotals(
    $runtime.instanceId,
    metricViewName,
    {
      measureNames: ["count"],
      inlineMeasures: [
        {
          name: "count",
          expression: "count(*)",
        },
      ],
    },
    {
      query: {
        // This should not be needed, but we are getting occasional query failures where the query gets stuck on status: 'loading' when using the autogenerated key.
        // TODO: investigate this further
        queryKey: ["dashboardAllRowsCt", metricViewName],
        enabled: true,
      },
    }
  );

  $: dashboardStore = useDashboardStore(metricViewName);

  $: metricTimeSeries = useModelHasTimeSeries(
    $runtime.instanceId,
    metricViewName
  );
  $: hasTimeSeries = $metricTimeSeries.data;

  $: timeStart = $dashboardStore?.selectedTimeRange?.start?.toISOString();
  let timeEnd;
  $: {
    let maybeEnd = $dashboardStore?.selectedTimeRange?.end;
    if (maybeEnd) {
      timeEnd = new Date(maybeEnd.valueOf() + 1).toISOString();
    }
  }

  $: filteredTotalsQuery = createQueryServiceMetricsViewTotals(
    $runtime.instanceId,
    metricViewName,
    {
      measureNames: ["count"],
      inlineMeasures: [
        {
          name: "count",
          expression: "count(*)",
        },
      ],
      timeStart: hasTimeSeries ? timeStart : undefined,
      timeEnd: hasTimeSeries ? timeEnd : undefined,
      filter: $dashboardStore?.filters,
    },
    {
      query: {
        queryKey: [
          "dashboardFilteredRowsCt",
          metricViewName,
          {
            timeStart,
            timeEnd,
            filter: $dashboardStore?.filters,
          },
        ],
        enabled:
          (hasTimeSeries ? !!timeStart && !!timeEnd : true) &&
          !!$dashboardStore?.filters,
      },
    }
  );

  let label = "";

  $: {
    if ($totalsQuery.data && $filteredTotalsQuery.data) {
      label = `${formatCompactInteger(
        $filteredTotalsQuery.data.data.count
      )} of ${formatCompactInteger($totalsQuery.data.data.count)} rows`;
    }
  }
</script>

<div>
  <button
    class="w-full bg-gray-100 h-7 text-left px-2 border-t border-t-gray-200 text-xs text-gray-800 flex items-center gap-1"
    on:click={toggle}
    aria-label="Toggle rows viewer"
  >
    <span class="font-bold">Model Data</span>
    {label}
    {#if isOpen}
      <CaretUpIcon size="14px" />
    {:else}
      <CaretDownIcon size="14px" />
    {/if}
  </button>
  {#if isOpen}
    <RowsViewer {metricViewName} />
  {/if}
</div>

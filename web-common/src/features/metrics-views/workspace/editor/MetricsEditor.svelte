<script lang="ts">
  import type { EditorView } from "@codemirror/view";
  import YAMLEditor from "@rilldata/web-common/components/editor/YAMLEditor.svelte";
  import {
    createRuntimeServiceGetCatalogEntry,
    createRuntimeServiceGetFile,
  } from "@rilldata/web-common/runtime-client";
  import { runtime } from "@rilldata/web-common/runtime-client/runtime-store";
  import MetricsEditorContainer from "./MetricsEditorContainer.svelte";

  import { setLineStatuses } from "@rilldata/web-common/components/editor/line-status";
  import { getFilePathFromNameAndType } from "@rilldata/web-common/features/entity-management/entity-mappers";
  import {
    fileArtifactsStore,
    getFileArtifactReconciliationErrors,
  } from "@rilldata/web-common/features/entity-management/file-artifacts-store";
  import { EntityType } from "@rilldata/web-common/features/entity-management/types";
  import { useQueryClient } from "@tanstack/svelte-query";
  import { mapReconciliationErrorsToLines } from "../../errors";
  import { createPlaceholder } from "./create-placeholder";
  import { createUpdateMetricsCallback } from "./update-metrics";

  export let metricsDefName: string;

  let editor: YAMLEditor;

  const queryClient = useQueryClient();

  /** create placeholder codemirror extension and set the inner svelte component
   * generated by the createPlaceholder callback.
   */
  const placeholderElements = createPlaceholder(metricsDefName);
  $: if (view) {
    placeholderElements.component.setEditorView(view);
  }

  /** create an updateMetrics event callback based on the queryClient
   * and metricsDefName.
   */
  const updateMetrics = createUpdateMetricsCallback(
    queryClient,
    metricsDefName
  );

  /**
   * Handle errors.
   */
  // get the yaml blob from the file.
  $: fileQuery = createRuntimeServiceGetFile(
    $runtime.instanceId,
    getFilePathFromNameAndType(metricsDefName, EntityType.MetricsDefinition)
  );

  $: catalogQuery = createRuntimeServiceGetCatalogEntry(
    $runtime.instanceId,
    metricsDefName
  );

  $: yaml = $fileQuery.data?.blob || "";
  $: runtimeErrors = getFileArtifactReconciliationErrors(
    $fileArtifactsStore,
    `${metricsDefName}.yaml`
  );

  $: lineBasedRuntimeErrors = mapReconciliationErrorsToLines(
    runtimeErrors,
    yaml
  );
  /** display the main error (the first in this array) at the bottom */
  $: mainError = [...lineBasedRuntimeErrors, ...(runtimeErrors || [])]?.at(0);

  let view: EditorView;
  /** If the errors change, run the following transaction. */
  $: if (view && !$catalogQuery?.isFetching && $catalogQuery?.isError)
    setLineStatuses(lineBasedRuntimeErrors, view);
</script>

<MetricsEditorContainer error={yaml?.length ? mainError : undefined}>
  <YAMLEditor
    bind:this={editor}
    content={yaml}
    bind:view
    on:update={updateMetrics}
    extensions={[placeholderElements.extension]}
  />
</MetricsEditorContainer>

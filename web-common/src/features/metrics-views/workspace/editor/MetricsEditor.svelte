<script lang="ts">
  import type { EditorView } from "@codemirror/view";
  import YAMLEditor from "@rilldata/web-common/components/editor/YAMLEditor.svelte";
  import { setLineStatuses } from "@rilldata/web-common/components/editor/line-status";
  import { mapParseErrorsToLines } from "../../errors";
  import MetricsEditorContainer from "./MetricsEditorContainer.svelte";
  import { createPlaceholder } from "./create-placeholder";
  import { createUpdateMetricsCallback } from "./update-metrics";
  import type { V1Resource } from "@rilldata/web-common/runtime-client";
  import type { V1ParseError } from "@rilldata/web-common/runtime-client";
  import { QueryObserverResult } from "@tanstack/svelte-query";
  import { HTTPError } from "@rilldata/web-common/runtime-client/fetchWrapper";

  export let filePath: string;
  export let yaml: string;
  export let metricViewName: string;
  export let allErrors: V1ParseError[];
  export let dashboard: QueryObserverResult<V1Resource, HTTPError>;

  let view: EditorView;

  /** create placeholder codemirror extension and set the inner svelte component
   * generated by the createPlaceholder callback.
   */
  $: placeholderElements = createPlaceholder(metricViewName);
  $: if (view) placeholderElements.component.setEditorView(view);

  /** create an updateMetrics event callback based on the queryClient
   * and metricsDefName.
   */
  $: updateMetrics = createUpdateMetricsCallback(filePath, metricViewName);

  $: lineBasedRuntimeErrors = mapParseErrorsToLines(allErrors, yaml);
  /** display the main error (the first in this array) at the bottom */
  $: mainError = lineBasedRuntimeErrors?.at(0);

  /** If the errors change, run the following transaction. */
  $: if (
    view &&
    !dashboard.isFetching &&
    (dashboard.isError || dashboard.data?.meta?.reconcileError)
  )
    setLineStatuses(lineBasedRuntimeErrors, view);
</script>

<MetricsEditorContainer error={yaml?.length ? mainError : undefined}>
  <YAMLEditor
    bind:view
    content={yaml}
    extensions={[placeholderElements.extension]}
    on:update={updateMetrics}
  />
</MetricsEditorContainer>

<script lang="ts">
  import { goto } from "$app/navigation";
  import Button from "@rilldata/web-common/components/button/Button.svelte";
  import Dialog from "@rilldata/web-common/components/dialog-v2/Dialog.svelte";
  import CheckCircleNew from "@rilldata/web-common/components/icons/CheckCircleNew.svelte";
  import { useCreateDashboardFromSourceUIAction } from "@rilldata/web-common/features/sources/createDashboard";
  import { sourceImportedName } from "@rilldata/web-common/features/sources/sources-store";
  import { runtime } from "@rilldata/web-common/runtime-client/runtime-store";

  export let open: boolean;

  $: dashboardFromSourceUIAction =
    $sourceImportedName !== null
      ? useCreateDashboardFromSourceUIAction(
          $runtime.instanceId,
          $sourceImportedName,
        )
      : null;

  function close() {
    sourceImportedName.set(null);
  }

  function goToSource() {
    goto(`/source/${$sourceImportedName}`);
    close();
  }

  async function autoGenerateDashboard() {
    // This should never happen, because the button is
    // disabled when this is null, but adding this check
    // for type narrowing and just in case.
    if (dashboardFromSourceUIAction === null) return;
    await dashboardFromSourceUIAction();
    close();
  }
</script>

<Dialog on:close={close} {open}>
  <div class="flex flex-auto gap-x-2.5" slot="title">
    <div class="w-6 m-auto ml-0 mr-0">
      <CheckCircleNew className="fill-primary-500" size="24px" />
    </div>
    <div>Source imported successfully</div>
  </div>
  <div class="flex flex-auto gap-x-2.5" slot="body">
    <div class="w-6" />
    <div class="text-slate-500">
      <span class="font-mono text-slate-800 break-all"
        >{$sourceImportedName}</span
      > has been ingested. What would you like to do next?
    </div>
  </div>
  <div class="flex flex-row-reverse gap-x-2 mt-4" slot="footer">
    <Button
      on:click={autoGenerateDashboard}
      type="primary"
      disabled={dashboardFromSourceUIAction === null}
      >Autogenerate Dashboard</Button
    >
    <Button on:click={goToSource} type="secondary">View this source</Button>
  </div>
</Dialog>

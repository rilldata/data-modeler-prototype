<script lang="ts">
  import { goto } from "$app/navigation";
  import Button from "@rilldata/web-common/components/button/Button.svelte";
  import Dialog from "@rilldata/web-common/components/dialog/Dialog.svelte";
  import CheckCircleNew from "@rilldata/web-common/components/icons/CheckCircleNew.svelte";
  import {
    FileArtifact,
    fileArtifacts,
  } from "@rilldata/web-common/features/entity-management/file-artifacts";
  import { sourceImportedPath } from "@rilldata/web-common/features/sources/sources-store";
  import { runtime } from "@rilldata/web-common/runtime-client/runtime-store";
  import { CreateQueryResult, useQueryClient } from "@tanstack/svelte-query";
  import { WandIcon } from "lucide-svelte";
  import { BehaviourEventMedium } from "../../../metrics/service/BehaviourEventTypes";
  import { MetricsEventSpace } from "../../../metrics/service/MetricsTypes";
  import type { V1Resource } from "../../../runtime-client";
  import type { HTTPError } from "../../../runtime-client/fetchWrapper";
  import { extractFileName } from "../../entity-management/file-path-utils";
  import { featureFlags } from "../../feature-flags";
  import { useCreateDashboardFromTableUIAction } from "../../metrics-views/ai-generation/generateMetricsView";

  const { ai } = featureFlags;

  export let sourcePath: string | null;

  $: sourceName = extractFileName(sourcePath ?? "");

  const queryClient = useQueryClient();

  $: runtimeInstanceId = $runtime.instanceId;
  let fileArtifact: FileArtifact;
  let sourceQuery: CreateQueryResult<V1Resource, HTTPError>;
  $: if (sourcePath) {
    fileArtifact = fileArtifacts.getFileArtifact(sourcePath);
    sourceQuery = fileArtifact.getResource(queryClient, runtimeInstanceId);
  }
  $: sinkConnector = $sourceQuery?.data?.source?.spec?.sinkConnector;

  $: createDashboardFromTable =
    sourcePath !== null
      ? useCreateDashboardFromTableUIAction(
          $runtime.instanceId,
          sinkConnector as string,
          "",
          "",
          sourceName,
          "dashboards",
          BehaviourEventMedium.Button,
          MetricsEventSpace.Modal,
        )
      : null;

  function close() {
    sourceImportedPath.set(null);
  }

  async function goToSource() {
    await goto(`/files${$sourceImportedPath ?? ""}`);
    close();
  }

  async function autoGenerateDashboard() {
    // This should never happen, because the button is
    // disabled when this is null, but adding this check
    // for type narrowing and just in case.
    if (createDashboardFromTable === null) return;
    close();
    await createDashboardFromTable();
  }
</script>

<Dialog on:close={close} open={!!sourcePath}>
  <div class="flex flex-auto gap-x-2.5" slot="title">
    <div class="w-6 m-auto ml-0 mr-0">
      <CheckCircleNew className="fill-primary-500" size="24px" />
    </div>
    <div>Source imported successfully</div>
  </div>
  <div class="flex flex-auto gap-x-2.5" slot="body">
    <div class="w-6" />
    <div class="text-slate-500">
      <span class="font-mono text-slate-800 break-all">{sourceName}</span> has been
      ingested. What would you like to do next?
    </div>
  </div>
  <div class="flex flex-row-reverse gap-x-2 mt-4" slot="footer">
    <Button
      disabled={createDashboardFromTable === null}
      on:click={autoGenerateDashboard}
      type="primary"
    >
      Generate dashboard

      {#if $ai}
        with AI
        <WandIcon class="w-3 h-3" />
      {/if}
    </Button>
    <Button on:click={goToSource} type="secondary">View this source</Button>
  </div>
</Dialog>

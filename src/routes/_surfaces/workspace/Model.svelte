<script lang="ts">
import { getContext } from "svelte";
import { slide } from "svelte/transition";
import type { AppStore } from '$lib/app-store';
import { cubicOut as easing } from 'svelte/easing';
import Editor from "$lib/components/Editor.svelte";
import {dataModelerService} from "$lib/app-store";

import PreviewTable from "$lib/components/table/PreviewTable.svelte";

const store = getContext("rill:app:store") as AppStore;
const queryHighlight = getContext("rill:app:query-highlight");

let error;

let errorLineNumber;
let errorMessage;

let showPreview = true;

function getErrorLineNumber(errorString) {
  if (!errorString.includes('LINE')) return { message: errorString };
  const [message, linePortion] = errorString.split('LINE ');
  const lineNumber = parseInt(linePortion.split(':')[0]);
  return { message, lineNumber };
};

$: currentModel = $store?.activeAsset ? $store.models.find(query => query.id === $store.activeAsset.id) : undefined;

</script>

<div class="editor-pane">
  <div>
  {#if $store && $store.models && currentModel}
    <div class="input-body p-6 overflow-auto">
      {#key currentModel?.id}
        <Editor 
          content={currentModel.query}
          name={currentModel.name}
          selections={$queryHighlight}
          errorLineNumber={ currentModel.id === $store.activeAsset.id ? errorLineNumber : undefined }
          on:down={() => { dataModelerService.dispatch('moveModelDown', [currentModel.id]); }}
          on:up={() => { dataModelerService.dispatch('moveModelUp', [currentModel.id]); }}
          on:delete={() => { dataModelerService.dispatch('deleteModel', [currentModel.id]); }}
          on:receive-focus={() => {
              dataModelerService.dispatch('setActiveAsset', [currentModel.id, 'model']);
              //dataModelerService.dispatch('updateQueryInformation', [{id: currentQuery.id }]);
          }}
          on:release-focus={() => {
            //dataModelerService.dispatch('releaseActiveQueryFocus', [{ id: q.id }]);
          }}
          on:model-profile={() => {
            //dataModelerService.dispatch('computeModelProfile', [{ id: currentQuery.id }]);
          }}
          on:rename={(evt) => {
            dataModelerService.dispatch('updateModelName', [currentModel.id, evt.detail]);
          }}
          on:write={(evt)=> {
              dataModelerService.dispatch('setActiveAsset', [currentModel.id, 'model']);
              dataModelerService.dispatch('updateModelQuery', [currentModel.id, evt.detail.content ]);
              //dataModelerService.dispatch('updateQueryInformation', [{ id: currentQuery.id }]);
          }}
      />
    {/key}
    {#if $store.activeAsset && $store.models.find(q => q.id === $store.activeAsset.id)?.error}
      <div transition:slide={{ duration: 200, easing }} 
        class="error p-4 m-4 rounded-lg shadow-md"
      >
        {$store.models.find(q => q.id === $store.activeAsset.id).error}
      </div>
    {/if}
    </div>
  {/if}
</div>
<!-- Show the model output preview -->
{#if currentModel}
  <div style:font-size="12px" class="overflow-hidden h-full grid p-5" style:grid-template-rows="max-content auto">
    <button on:click={() => { showPreview = !showPreview }}>{#if showPreview}hide{:else}show{/if} preview</button>
    <div class="rounded overflow-auto border border border-gray-300 {!showPreview && 'hidden'}"
    >
      {#if currentModel?.preview && currentModel?.profile}
        <PreviewTable rows={currentModel.preview} columnNames={currentModel.profile} />
      {:else}
        <div class="p-5  grid items-center justify-center italic">no columns selected</div>
      {/if}
    </div>
  </div>
  {/if}
</div>
<style>

.editor-pane {
  display: grid;
  grid-template-rows: auto 400px;
  height: calc(100vh - var(--header-height));
}
.error {
  background-color: var(--error-bg);
  color: var(--error-text);
  font-size: 13px;
  align-self: bottom;
}
</style>
---
title: "Let's get back to our project"
description:  Further build on project
sidebar_label: "Advanced SQL modeling"
sidebar_position: 16
---
## Advanced SQL modeling

First, let's revisit our SQL model.
It is a simple join between two tables that was able to give us the user details and the commit details. But, in reality that doesn't give us much information about the repository. We can see some added and removed lines and filter based on the user and filename. Let's make a few more modifications.

Let's create a new model file `advanced_commits___mode.sql`.

:::tip
    We will add our original SQL code to a CTE (common table expression) with a few modifications then from there, create our expanded SQL query. 
:::

Without going into a whole SQL lecture in this course, we will make some modifications to the SQL in order to create some useful measures and dimensions. 

Using the initially created table as a CTE, we will use some of <a href= 'https://duckdb.org/docs/sql/functions/regular_expressions' target="blank" >DuckDB's internal functions</a> to modify the original columns to something more useful.

```SQL
-- Model SQL
-- Reference documentation: https://docs.rilldata.com/reference/project-files/models
-- @materialize: true

-- CTE commit_file_stats view
WITH commit_file_stats AS (
    SELECT
        a.*,
        b.filename,
        b.added_lines,
        b.deleted_lines,
        REGEXP_EXTRACT(b.new_path, '(.*/)', 1) AS directory_path, 
    FROM
        commits__ a
    inner JOIN
        modified_files__ b
    ON
        a.commit_hash = b.commit_hash
)
SELECT
    --timeseries column
    author_date,

    -- dimensions
    author_name,
    directory_path,
    filename,
    STRING_AGG(DISTINCT commit_msg, ', ') AS commit_msg

    --added for some information purposes, you'll see!
    sum(added_lines) as added_lines, 
    sum(deleted_lines) as deleted_lines, 

    -- measures
    COUNT(DISTINCT commit_hash) AS num_commits,
    SUM(added_lines) - SUM(deleted_lines) AS net_line_changes, 
    SUM(added_lines) + SUM(deleted_lines) AS total_line_changes, 
    (SUM(deleted_lines) / (SUM(added_lines) + SUM(deleted_lines))) as CodeDeletePercent, 

FROM
    commit_file_stats -- CTE table above
WHERE
    directory_path IS NOT NULL --remove the NULL values from directory_path
GROUP BY
    directory_path, filename, author_name, author_date -- group by helps performance of filtering, but comes at a price
ORDER BY
    directory_path DESC 
    ```

The resulting SQL allows us to filter using the dimensions: `author_date`, `directory_path`, `filename` and `commit_msg`.

It gives us the following measures: `number of commits`, `net line changes`, `added_lines` and `deleted_lines`.

Using this model, we can create a new dashboard with more informative capabilities!


import DocsRating from '@site/src/components/DocsRating';

---
<DocsRating />
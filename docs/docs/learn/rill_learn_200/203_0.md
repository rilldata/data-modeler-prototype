---
title: "Let's get back to our project"
description:  Further build on project
sidebar_label: "Advanced SQL modeling"
sidebar_position: 16
---
## Advanced SQL modeling

First, let's revisit our SQL model.
It is a simple join between two tables that was able to give us the user details and the commit details. But, in reality that doesn't give us much information about the repository. We can see some added and removed lines and filter based on the user and filename. Let's make a few more modifications.

:::tip
    We will add our original SQL code to a CTE (common table expression) with a few modifications then from there, create our expanded SQL query. 
:::



```SQL
-- Model SQL
-- Reference documentation: https://docs.rilldata.com/reference/project-files/models
-- @materialize: true

WITH commit_file_stats AS (
    SELECT
        a.*,
        b.filename,
        b.added_lines,
        b.deleted_lines,
        REGEXP_EXTRACT(b.new_path, '(.*/)', 1) AS directory_path, #using DuckDB's function REGEXP_EXTRACT, 
        #we are removing the filename from the new_path column
    FROM
        commits__ a
    inner JOIN
        modified_files__ b
    ON
        a.commit_hash = b.commit_hash
)
SELECT
    author_date,
    author_name,
    directory_path,
    filename,
    COUNT(DISTINCT commit_hash) AS num_commits, #counting the distinct number of commits 
    SUM(added_lines) - SUM(deleted_lines) AS net_line_changes, #net line changes
    SUM(added_lines) + SUM(deleted_lines) AS total_line_changes, #total line changes
    (SUM(deleted_lines) / (SUM(added_lines) + SUM(deleted_lines)))*100 as CodeDeletePercent, 
    #Percent deletes [del / (sum + del)] * 100

FROM
    commit_file_stats #our CTE view
GROUP BY
    directory_path, filename, author_name, author_date #non-aggregate columns, need to be in group by
ORDER BY
    directory_path DESC 
    ```


import DocsRating from '@site/src/components/DocsRating';

---
<DocsRating />